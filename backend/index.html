<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cover Letter Generator</title>
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden {
            display: none;
        }
        .loading {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-3xl mx-auto bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold text-center mb-6">Cover Letter Generator</h1>
        
        <!-- Form -->
        <form id="coverLetterForm" class="space-y-6" hx-encoding="multipart/form-data" hx-post="http://localhost:8000/generate_cover_letter" hx-target="#result-container" hx-indicator="#loading">
            <!-- Resume Upload -->
            <div>
                <label for="cv_file" class="block text-sm font-medium text-gray-700 mb-1">Upload Resume (PDF or DOCX)</label>
                <input type="file" id="cv_file" name="cv_file" accept=".pdf,.docx" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
            </div>
            
            <!-- Job Description Choice -->
            <div>
                <p class="block text-sm font-medium text-gray-700 mb-1">Job Description</p>
                <div class="flex space-x-4 mb-2">
                    <label class="inline-flex items-center">
                        <input type="radio" name="job_desc_type" value="text" checked class="form-radio" onclick="toggleJobDescInput('text')">
                        <span class="ml-2">Enter Text</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="job_desc_type" value="image" class="form-radio" onclick="toggleJobDescInput('image')">
                        <span class="ml-2">Upload Image</span>
                    </label>
                </div>
                
                <!-- Job Description Text Input -->
                <div id="job_desc_text_container">
                    <textarea id="job_desc_text" name="job_desc_text" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Paste job description here..."></textarea>
                </div>
                
                <!-- Job Description Image Upload -->
                <div id="job_desc_image_container" class="hidden">
                    <input type="file" id="job_desc_image" name="job_desc_image" accept=".jpg,.jpeg,.png" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
            </div>
            
            <!-- Company Name -->
            <div>
                <label for="company_name" class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
                <input type="text" id="company_name" name="company_name" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Enter company name...">
            </div>
            
            <!-- Word Limit -->
            <div>
                <label for="word_limit" class="block text-sm font-medium text-gray-700 mb-1">Word Limit</label>
                <input type="number" id="word_limit" name="word_limit" min="50" max="2000" value="500" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                <p class="text-xs text-gray-500 mt-1">Min: 50, Max: 2000</p>
            </div>
            
            <!-- Submit Button -->
            <div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition">
                    Generate Cover Letter
                </button>
            </div>
        </form>
        
        <!-- Loading indicator -->
        <div id="loading" class="hidden">
            <div class="mt-6 p-4 border border-gray-200 rounded-md bg-gray-50">
                <div class="flex items-center justify-center">
                    <svg class="animate-spin h-5 w-5 text-blue-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-700">Generating your cover letter... This may take a moment.</p>
                </div>
            </div>
        </div>
        
        <!-- Results Container -->
        <div id="result-container" class="mt-8 hidden">
            <h2 class="text-xl font-semibold mb-3">Your Cover Letter</h2>
            <div class="flex justify-end mb-2">
                <button onclick="copyToClipboard()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-1 px-3 rounded-md text-sm flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-12a2 2 0 00-2-2h-2M8 5a2 2 0 002-2h4a2 2 0 002 2M8 5a2 2 0 012-2h4a2 2 0 012 2" />
                    </svg>
                    Copy
                </button>
            </div>
            <textarea id="generated-text" class="w-full h-80 px-3 py-2 border border-gray-300 rounded-md font-sans leading-relaxed" style="white-space: pre-wrap;" readonly></textarea>
        </div>
    </div>

    <script>
        // Toggle between job description text and image input
        function toggleJobDescInput(type) {
            const textContainer = document.getElementById('job_desc_text_container');
            const imageContainer = document.getElementById('job_desc_image_container');
            const textInput = document.getElementById('job_desc_text');
            const imageInput = document.getElementById('job_desc_image');
            
            if (type === 'text') {
                textContainer.classList.remove('hidden');
                imageContainer.classList.add('hidden');
                imageInput.value = ''; // Clear image input
            } else {
                textContainer.classList.add('hidden');
                imageContainer.classList.remove('hidden');
                textInput.value = ''; // Clear text input
            }
        }
        
        // Copy generated text to clipboard
        function copyToClipboard() {
            const textarea = document.getElementById('generated-text');
            textarea.select();
            document.execCommand('copy');
            
            // Visual feedback
            const copyButton = document.querySelector('button[onclick="copyToClipboard()"]');
            const originalText = copyButton.innerHTML;
            
            copyButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                Copied!
            `;
            
            setTimeout(() => {
                copyButton.innerHTML = originalText;
            }, 2000);
        }
        
        // Form submission handler
        document.addEventListener('htmx:beforeRequest', function(event) {
            // Get selected job description type
            const jobDescType = document.querySelector('input[name="job_desc_type"]:checked').value;
            
            // Clear the unused field to avoid sending both
            if (jobDescType === 'text') {
                document.getElementById('job_desc_image').disabled = true;
            } else {
                document.getElementById('job_desc_text').disabled = true;
            }
        });
        
        // After response is received
        document.addEventListener('htmx:afterRequest', function(event) {
            // Re-enable all fields
            document.getElementById('job_desc_text').disabled = false;
            document.getElementById('job_desc_image').disabled = false;
            
            // Show result container
            const resultContainer = document.getElementById('result-container');
            resultContainer.classList.remove('hidden');
            
            // Populate textarea with response, preserving line breaks and structure
            const generatedText = document.getElementById('generated-text');
            const responseText = event.detail.xhr.responseText;
            
            // The backend already sends properly formatted text/plain with newlines
            generatedText.value = responseText;
            generatedText.readOnly = false; // Allow editing
            
            // Automatically adjust textarea height to content
            generatedText.style.height = 'auto';
            generatedText.style.height = (generatedText.scrollHeight + 10) + 'px';
        });
    </script>
</body>
</html>